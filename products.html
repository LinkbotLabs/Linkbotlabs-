<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LinkBotLabs Affiliate Shop</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size:16px; background: linear-gradient(180deg,#000,#1a1a1a); color:#fff; margin:0; }
h1 { text-align:center; color:cyan; margin:15px 0; }
.affiliate-banner { background:#0077b6; color:#fff; padding:12px; text-align:center; font-weight:bold; }
.container { padding:10px; }
.categories { display:flex; gap:10px; overflow-x:auto; margin-bottom:15px; }
.category-box { padding:8px 14px; background:#222; border-radius:6px; cursor:pointer; color:cyan; white-space:nowrap; flex:0 0 auto; }
.category-box:hover { background:#333; }
.products { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; }
.product-card { background:rgba(26,26,46,0.85); border:1px solid #3a3a5d; border-radius:10px; padding:16px; width:220px; text-align:center; }
.product-title { font-size:20px; font-weight:bold; margin:10px 0; }
.product-price { color:cyan; font-weight:bold; margin:8px 0; }
.product-desc { font-size:14px; color:#ccc; margin-bottom:12px; }
.product-btn { padding:12px; background:black; border:2px solid cyan; border-radius:8px; color:white; font-weight:bold; cursor:pointer; width:90%; transition:0.2s; }
.product-btn:hover { background:cyan; color:black; }
.affiliate-section { background: rgba(10,10,40,0.6); padding:16px; margin:15px 0; border-radius:10px; border:1px solid rgba(0,255,255,0.3);}
.affiliate-section input, .affiliate-section button { width:100%; padding:12px; margin:6px 0; border-radius:6px; border:none; font-size:1rem;}
.affiliate-section input { background: rgba(15,15,50,0.7); color:#fff; }
.affiliate-section button { background: linear-gradient(135deg,#00ffff,#00bfff); color:#0b0c22; font-weight:bold; cursor:pointer; transition:0.3s; }
.affiliate-section button:hover { opacity:0.85; }
.output { margin-top:8px; color:#00ffea; }
@media(max-width:768px){ .products{justify-content:center;} .product-card{width:90%;} }
</style>
</head>
<body>

<div class="affiliate-banner" id="affiliate-banner"></div>
<h1>âœ¨ LinkBotLabs Affiliate Shop âœ¨</h1>

<div class="container">
  <div class="categories" id="categories"></div>
  <div class="products" id="products"></div>
  <div class="gcse-search"></div>

  <div class="affiliate-section">
    <h2>ðŸš€ Join the Affiliate Program</h2>
    <p>Enter your affiliate tag to activate it:</p>
    <form id="affiliateForm">
      <input type="text" id="userAffiliate" placeholder="Enter your tag (mytag-20)" required>
      <button type="submit">Activate Affiliate Tag</button>
    </form>
    <div id="regOutput" class="output"></div>
  </div>
</div>

<!-- Google CSE -->
<script async src="https://cse.google.com/cse.js?cx=f7e219616fe1d4629"></script>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "linkbotlabs-41504489.firebaseapp.com",
  projectId: "linkbotlabs-41504489"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let categoriesDiv = document.getElementById("categories");
let productsDiv = document.getElementById("products");

// Affiliate
let userAffiliateTag = localStorage.getItem('affiliateTag') || "";
function updateBanner() {
  const banner = document.getElementById("affiliate-banner");
  banner.textContent = userAffiliateTag ? `âœ… Active Affiliate: ${userAffiliateTag}` : "â„¹ï¸ No affiliate tag set.";
}
updateBanner();

// Load products from Firestore
let productData = {};
async function loadProducts() {
  try {
    const snapshot = await getDocs(collection(db, "products"));
    productData = {};
    snapshot.forEach(doc => {
      const p = doc.data();
      if(!productData[p.category]) productData[p.category] = [];
      productData[p.category].push(p);
    });
    renderCategories();
    renderProducts();
  } catch(err) {
    console.error("Firestore failed, falling back to products.json", err);
    // Fallback to JSON
    fetch('products.json')
      .then(r => r.json())
      .then(data => { productData = data; renderCategories(); renderProducts(); })
      .catch(()=>{ productData = {}; renderCategories(); renderProducts(); });
  }
}

// Render categories
function renderCategories() {
  categoriesDiv.innerHTML = "";
  const allBox = document.createElement("div");
  allBox.className = "category-box"; allBox.textContent = "All";
  allBox.onclick = ()=>renderProducts();
  categoriesDiv.appendChild(allBox);
  for(const cat of Object.keys(productData)){
    const box = document.createElement("div");
    box.className = "category-box"; box.textContent = cat;
    box.onclick = ()=>renderProducts(cat);
    categoriesDiv.appendChild(box);
  }
}

// Render products
function renderProducts(category){
  productsDiv.innerHTML = "";
  let filtered = [];
  if(!category || category==="All"){
    for(const items of Object.values(productData)) filtered.push(...items);
  } else filtered = productData[category] || [];

  filtered.forEach(p=>{
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <h3 class="product-title">${p.title}</h3>
      <p class="product-price">${p.price}</p>
      <p class="product-desc">${p.description}</p>
      <button class="product-btn">ðŸ›’ Buy Now</button>
    `;
    card.querySelector("button").onclick = ()=>{
      let link = p.url;
      if(userAffiliateTag) link += (p.url.includes("?") ? "&" : "?") + "tag=" + userAffiliateTag;
      window.open(link,"_blank");
    };
    productsDiv.appendChild(card);
  });
}

// Affiliate form
document.getElementById("affiliateForm").addEventListener("submit", e=>{
  e.preventDefault();
  const tag = document.getElementById("userAffiliate").value.trim();
  if(tag){
    userAffiliateTag = tag;
    localStorage.setItem('affiliateTag',tag);
    document.getElementById("regOutput").innerText = `âœ… Tag "${tag}" saved!`;
    updateBanner();
  } else document.getElementById("regOutput").innerText = "âŒ Enter a valid affiliate tag.";
});

// Append affiliate to Google search links
function appendAffiliateToCSE() {
  const userTag = localStorage.getItem("affiliateTag") || "davids-20";
  const observer = new MutationObserver(() => {
    document.querySelectorAll(".gsc-results .gsc-thumbnail-inside a, .gsc-results .gsc-url-top a").forEach(link => {
      if (!link.dataset.affiliateApplied) {
        let url = new URL(link.href);
        url.searchParams.set("tag", userTag);
        link.href = url.toString();
        link.dataset.affiliateApplied = true;
      }
    });
  });
  observer.observe(document.body, { childList:true, subtree:true });
}
window.addEventListener("load", ()=>{
  loadProducts();
  appendAffiliateToCSE();
});
</script>
</body>
</html>
