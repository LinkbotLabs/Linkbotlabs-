<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config (optional)
let db;
try {
  const firebaseConfig = {
    apiKey: "AIzaSyAmfbpdZvSMzAcU9AwPqKojKG08K3Qe0SE",
    authDomain: "linkbotlabs.firebaseapp.com",
    projectId: "linkbotlabs",
    storageBucket: "linkbotlabs.firebasestorage.app",
    messagingSenderId: "413558906075",
    appId: "1:413558906075:web:a92dc7ec6cbeccec0540fe"
  };
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
} catch(e) {
  console.warn("Firestore not available:", e.message);
}

// Affiliate tag
let userAffiliateTag = localStorage.getItem('affiliateTag') || "mychanneld-20";
function updateBanner() {
  const banner = document.getElementById("affiliate-banner");
  banner.textContent = userAffiliateTag ? `âœ… Active Affiliate: ${userAffiliateTag}` : "â„¹ï¸ No affiliate tag set.";
}
updateBanner();

// Load local products
let productData = {};
async function loadProducts() {
  try {
    const res = await fetch('products.json');
    productData = await res.json();
  } catch(err) {
    console.error("Failed to load products.json:", err);
  }
  renderCategories();
  renderProducts();
}

function renderCategories() {
  const categoriesDiv = document.getElementById("categories");
  categoriesDiv.innerHTML = "";
  const allBox = document.createElement("div");
  allBox.className = "category-box";
  allBox.textContent = "All";
  allBox.onclick = () => renderProducts();
  categoriesDiv.appendChild(allBox);

  for(const cat of Object.keys(productData)){
    const box = document.createElement("div");
    box.className = "category-box";
    box.textContent = cat;
    box.onclick = () => renderProducts(cat);
    categoriesDiv.appendChild(box);
  }
}

function renderProducts(category) {
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML = "";
  let filtered = [];
  if(!category || category==="All"){
    for(const items of Object.values(productData)) filtered.push(...items);
  } else filtered = productData[category] || [];

  filtered.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    const imgTag = p.image ? `<img src="${p.image}">` : '';
    card.innerHTML = `
      ${imgTag}
      <h3 class="product-title">${p.title}</h3>
      <p class="product-price">${p.price || ''}</p>
      <p class="product-desc">${p.description || ''}</p>
      <button class="product-btn">ðŸ›’ Buy Now</button>
    `;
    card.querySelector("button").onclick = () => {
      let link = p.url.startsWith("http") ? p.url : "https://" + p.url;
      if(userAffiliateTag) link += (link.includes("?") ? "&" : "?") + "tag=" + userAffiliateTag;
      window.open(link, "_blank");
    };
    productsDiv.appendChild(card);
  });
}

// Affiliate form
document.getElementById("affiliateForm").addEventListener("submit", e=>{
  e.preventDefault();
  const tag = document.getElementById("userAffiliate").value.trim();
  if(tag){
    userAffiliateTag = tag;
    localStorage.setItem('affiliateTag', tag);
    document.getElementById("regOutput").innerText = `âœ… Tag "${tag}" saved!`;
    updateBanner();
  } else {
    document.getElementById("regOutput").innerText = "âŒ Enter a valid affiliate tag.";
  }
});

// Google CSE API Search
const API_KEY = "AIzaSyB9YwW8EVXQJsVwSMbJrk-NU9B9ZrzzkGs";
const CSE_ID = "f7e219616fe1d4629";

async function searchProducts(query) {
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML = "ðŸ”Ž Searchingâ€¦";
  try {
    const res = await fetch(`https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CSE_ID}&q=${encodeURIComponent(query)}&num=10`);
    const data = await res.json();
    if(!data.items || data.items.length===0){ productsDiv.innerHTML="No results found."; return; }

    productsDiv.innerHTML = "";
    const newProducts = [];

    data.items.forEach(item => {
      let link = item.link;
      const img = item.pagemap?.cse_image?.[0]?.src || '';
      const productObj = { title: item.title, description: item.snippet, url: link, image: img, category: "Search" };
      newProducts.push(productObj);

      if(userAffiliateTag) link += (link.includes("?") ? "&" : "?") + "tag=" + userAffiliateTag;

      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        ${img ? `<img src="${img}">` : ''}
        <h3 class="product-title">${item.title}</h3>
        <p class="product-desc">${item.snippet}</p>
        <button class="product-btn">ðŸ›’ Buy Now</button>
      `;
      card.querySelector("button").onclick = () => window.open(link,"_blank");
      productsDiv.appendChild(card);
    });

    // Optional Firestore backup
    if(db){
      newProducts.forEach(async p=>{
        try{
          const docRef = doc(db,"products",p.title.replace(/\W/g,"_"));
          const docSnap = await getDoc(docRef);
          if(!docSnap.exists()) await setDoc(docRef,p);
        } catch(e){ console.warn("Firestore save failed:", e.message); }
      });
    }

    // Merge into local categories
    if(!productData["Search"]) productData["Search"] = [];
    for(const p of newProducts){
      if(!productData["Search"].some(pr=>pr.title===p.title && pr.url===p.url)) productData["Search"].push(p);
    }
    renderCategories();

  } catch(e){ productsDiv.innerHTML = "Error: " + e.message; }
}

// Search button
document.getElementById("searchBtn").addEventListener("click", ()=>{
  const query = document.getElementById("searchInput").value.trim();
  if(query) searchProducts(query);
});

window.addEventListener("load", loadProducts);
</script>
